#!/bin/bash  

mkdir -p Reports  # Create Reports folder if it doesn't exist
mkdir -p Alerts   # Create Alerts folder if it doesn't exist

# Start main menu loop
while true; do
  echo ""
  echo "Attendance Tracker"
  echo "1) Analyze Attendance"
  echo "2) Search for Student"
  echo "3) Generate Alerts for Absences"
  echo "4) Exit"
  echo -n "Enter your choice: "
  read choice

  case $choice in

    1)  # ---------- Analyze Attendance ----------
      echo -n "Enter CSV file name (e.g., students.csv): "
      read file

      if [[ ! -f "$file" ]]; then
        echo "File not found!"
        continue
      fi

      report="Reports/report_$(date +%Y-%m-%d).txt"

      awk -F',' 'NR>1 {
        name = $1
        p = $2 + 0
        a = $3 + 0
        t = p + a

        if (t > 0) {
          percent = (p / t) * 100
          status = (percent >= 75) ? "✅" : "❌"
          printf "%s | %.1f%% | %s\n", name, percent, status
        } else {
          printf "%s | --- | No Data\n", name
        }
      }' "$file" | tee "$report"

      echo "Report saved to: $report"
      ;;

    2)  # ---------- Search for Student ----------
      read -p "Enter student name to search: " query

      echo "Search Results:"
      grep -i "$query" students.csv > /dev/null 2>&1

      if [ $? -ne 0 ]; then
          echo "No matching student found."
      else
          grep -i "$query" students.csv | while IFS=',' read -r name present absent hours
          do
              total=$((present + absent))
              if [ $total -gt 0 ]; then
                  absence_ratio=$(echo "scale=2; $absent*100/$total" | bc)
                  echo "Student: $name, Present Days: $present, Absent Days: $absent, Hours: $hours"
                  echo "Absence ratio: $absence_ratio%"
                  absence_check=$(echo "$absence_ratio > 25" | bc)
                  if [ "$absence_check" -eq 1 ]; then
                      echo "ALERT: You have exceeded 25% absence."
                  fi
              else
                  echo "Data insufficient for $name"
              fi
          done
      fi
      ;;

    3)  # ---------- Generate Absence Alerts ----------
      echo "Generating absence alerts..."

      awk -F',' 'NR>1 {
          total = $2 + $3
          if (total > 0) {
              ratio = $3 / total
              if (ratio > 0.25) {
                  printf("%s has high absence rate (%.2f%%) - You have exceeded 25%% absence.\n", $1, ratio*100)
              }
          }
      }' students.csv > alerts.txt

      today=$(date +%F)
      mv alerts.txt Alerts/alerts_$today.txt
      cp Alerts/alerts_$today.txt Reports/

      echo "Alerts generated and saved in Alerts/ and Reports/"
      ;;

    4)  # ---------- Exit ----------
      echo "Thank you for using Attendance Tracker!"
      exit
      ;;

    *)  # ---------- Invalid Choice ----------
      echo "Invalid choice. Try again."
      ;;
  esac
done

